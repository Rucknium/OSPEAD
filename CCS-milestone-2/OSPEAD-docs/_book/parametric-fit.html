<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Parametric Fit – OSPEAD-docs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./performance-evaluation.html" rel="next">
<link href="./real-spend-visualization.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-81b089a3b74ed4cf194f083418e7130b.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-70a0d8cd41196b3779e6040b3024b155.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./parametric-fit.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Parametric Fit</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">OSPEAD-docs</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./requirements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Requirements</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./successful-simulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Successful Simulation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ring-gathering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Ring Gathering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonstandard-transactions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Nonstandard Transactions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./broadcast-time.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Broadcast Time</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./miscellaneous-preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Miscellaneous Preparation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transformed-age.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Transformed Age</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bjr-and-patra-sen.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">BJR and Patra-Sen</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonparametric-real-spend.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Nonparametric Real Spend</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./real-spend-visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Real Spend Visualization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parametric-fit.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Parametric Fit</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./performance-evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Performance Evaluation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix-bjr-benchmarks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Appendix: BJR Benchmarks</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#objective-function" id="toc-objective-function" class="nav-link active" data-scroll-target="#objective-function"><span class="header-section-number">12.1</span> Objective function</a></li>
  <li><a href="#sec-parametric-distributions" id="toc-sec-parametric-distributions" class="nav-link" data-scroll-target="#sec-parametric-distributions"><span class="header-section-number">12.2</span> Parametric distributions</a></li>
  <li><a href="#implementation-details" id="toc-implementation-details" class="nav-link" data-scroll-target="#implementation-details"><span class="header-section-number">12.3</span> Implementation details</a>
  <ul class="collapse">
  <li><a href="#computational-expense" id="toc-computational-expense" class="nav-link" data-scroll-target="#computational-expense"><span class="header-section-number">12.3.1</span> Computational expense</a></li>
  <li><a href="#excess-tail-penalty" id="toc-excess-tail-penalty" class="nav-link" data-scroll-target="#excess-tail-penalty"><span class="header-section-number">12.3.2</span> Excess tail penalty</a></li>
  <li><a href="#parameter-initial-values" id="toc-parameter-initial-values" class="nav-link" data-scroll-target="#parameter-initial-values"><span class="header-section-number">12.3.3</span> Parameter initial values</a></li>
  </ul></li>
  <li><a href="#sec-parametric-fit-code" id="toc-sec-parametric-fit-code" class="nav-link" data-scroll-target="#sec-parametric-fit-code"><span class="header-section-number">12.4</span> Code</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-parametric-fit" class="quarto-section-identifier"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Parametric Fit</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Having estimated the nonparametric PMF, we now need to fit a parametric distribution.</p>
<p>First, the weekly PMFs must be aggregated. The value of the weekly PMFs at each support point can simply be averaged. Some weeks are excluded because of data availability problems or exogenous shocks:</p>
<ul>
<li>No txpool data for weeks 2023-13 and 2023-14</li>
<li>Volatility caused by Binance Monitoring Tag during weeks 2023-51, 2023-52, 2024-01, and 2024-02</li>
<li>Binance delisting during week 2024-06</li>
<li>Suspected black marble spam during weeks 2024-09, 2024-10, 2024-11, 2024-12, 2024-13, 2024-14, 2024-15, and 2024-16</li>
<li>Failure to estimate for unknown reasons for week 2024-19</li>
</ul>
<p>As stated in <a href="real-spend-visualization.html#sec-nonparametric-real-spend-mixing-proportions" class="quarto-xref"><span>Section 11.2</span></a> , the mixing proportion of the second-largest component distribution was estimated to be much larger during some of the exogenous events, suggesting inappropriate splitting of the <code>wallet2</code> ring distribution. In theory, the first and second estimated components could be re-combined by computing their weighted sum, with the estimated mixing proportions as their weights. The simpler solution is to exclude these weeks as anomalous, which is what I have done.</p>
<section id="objective-function" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="objective-function"><span class="header-section-number">12.1</span> Objective function</h2>
<p>Usually, fitting a parametric distribution to nonparametric data involves minimization or maximization of an objective function by adjusting the parametric distribution’s parameters until the best fit is achieved. In OSPEAD, the new decoy parametric probability distribution will be chosen by minimizing the probability that the Maximum A Posteriori (MAP) Decoder Attack described by <span class="citation" data-cites="Aeeneh2021">Aeeneh et al. (<a href="references.html#ref-Aeeneh2021" role="doc-biblioref">2021</a>)</span> is successful. Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math> be the total number of outputs eligible to be spent in a RingCT ring. Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>S</mi></msub><annotation encoding="application/x-tex">f_S</annotation></semantics></math> be the real spend probability mass function (PMF). Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>D</mi></msub><annotation encoding="application/x-tex">f_D</annotation></semantics></math> be a proposed decoy PMF. Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>𝟏</mn><mo stretchy="false" form="prefix">{</mo><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\mathbf{1}\{\}</annotation></semantics></math> be the indicator function that takes value 1 when the statement within the braces is true and 0 otherwise. The average success probability of the MAP Decoder attack is</p>
<p><span id="eq-map-decoder-simple"><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>M</mi><mi>A</mi><mi>P</mi><mspace width="0.222em"></mspace><mi>D</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>Z</mi></munderover><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>Z</mi></munderover><msub><mi>f</mi><mi>D</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>𝟏</mn><mrow><mo stretchy="true" form="prefix">{</mo><mfrac displaystyle="false"><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>f</mi><mi>D</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>&lt;</mo><mfrac displaystyle="false"><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>f</mi><mi>D</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo stretchy="true" form="postfix">}</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>M</mi></msup><mspace width="2.0em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mn>12.1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
L_{MAP\:Decoder}=\sum_{i=1}^{Z}f_{S}\left(i\right)\left(\sum_{j=1}^{Z}f_{D}\left(j\right)\mathbf{1}\left\{ \tfrac{f_{S}\left(j\right)}{f_{D}\left(j\right)}&lt;\tfrac{f_{S}\left(i\right)}{f_{D}\left(i\right)}\right\} \right)^{M}
 \qquad(12.1)</annotation></semantics></math></span></p>
<p>The <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_{S}\left(i\right)</annotation></semantics></math> weights the attack success probability by the probability mass at the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th output. Very old outputs are rarely spent, so they are given low weight. <a href="#eq-map-decoder-simple" class="quarto-xref">Equation&nbsp;<span>12.1</span></a> can be modified to give more weight to old outputs. The <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_{S}\left(i\right)</annotation></semantics></math> weight can be changed into a convex combination of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_{S}\left(i\right)</annotation></semantics></math> and giving each output an equal weight, parameterized by <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>λ</mi><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>λ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>1</mn><mi>Z</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\left(\lambda f_{S}\left(i\right)+(1-\lambda)\frac{1}{Z}\right)</annotation></semantics></math>. The more general objective function is</p>
<p><span id="eq-map-decoder-lambda"><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>M</mi><mi>A</mi><mi>P</mi><mspace width="0.222em"></mspace><mi>D</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>λ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>Z</mi></munderover><mrow><mo stretchy="true" form="prefix">(</mo><mi>λ</mi><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>λ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>1</mn><mi>Z</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>Z</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>f</mi><mi>D</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>𝟏</mn><mrow><mo stretchy="true" form="prefix">{</mo><mfrac displaystyle="false"><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>f</mi><mi>D</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>&lt;</mo><mfrac displaystyle="false"><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>f</mi><mi>D</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo stretchy="true" form="postfix">}</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>M</mi></msup><mspace width="2.0em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mn>12.2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
L_{MAP\:Decoder}(\lambda)=\sum_{i=1}^{Z}\left(\lambda f_{S}\left(i\right)+(1-\lambda)\frac{1}{Z}\right)\sum_{j=1}^{Z}\left(f_{D}\left(j\right)\mathbf{1}\left\{ \tfrac{f_{S}\left(j\right)}{f_{D}\left(j\right)}&lt;\tfrac{f_{S}\left(i\right)}{f_{D}\left(i\right)}\right\} \right)^{M}
 \qquad(12.2)</annotation></semantics></math></span></p>
<p>We shall use <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\lambda=1</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\lambda=0.5</annotation></semantics></math>.</p>
</section>
<section id="sec-parametric-distributions" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="sec-parametric-distributions"><span class="header-section-number">12.2</span> Parametric distributions</h2>
<p>The following parametric distributions will be fit:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Gamma_distribution">Gamma</a></li>
<li><a href="https://en.wikipedia.org/wiki/Noncentral_F-distribution">Non-central F</a></li>
<li>Right-Pareto Lognormal (RPLN) <span class="citation" data-cites="ReedJorgensen2004">(<a href="references.html#ref-ReedJorgensen2004" role="doc-biblioref">Reed and Jorgensen 2004</a>)</span></li>
<li><a href="https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution">Generalized Extreme Value (GEV)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Birnbaum%E2%80%93Saunders_distribution">Birnbaum-Saunders (BS)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Generalized_beta_distribution#Generalized_beta_of_the_second_kind_(GB2)">Generalized Beta of the Second Kind (GB2)</a></li>
</ul>
<p>Each distribution will be fitted on the raw nonparametric distribution and a log transformation of it.</p>
</section>
<section id="implementation-details" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="implementation-details"><span class="header-section-number">12.3</span> Implementation details</h2>
<section id="computational-expense" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="computational-expense"><span class="header-section-number">12.3.1</span> Computational expense</h3>
<p>Notice the double summation over <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math> in <a href="#eq-map-decoder-simple" class="quarto-xref">Equation&nbsp;<span>12.1</span></a> . <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math> is over 100 million. A naive implementation of <a href="#eq-map-decoder-simple" class="quarto-xref">Equation&nbsp;<span>12.1</span></a> would require over 10 quadrillion comparisons. Furthermore, <a href="#eq-map-decoder-simple" class="quarto-xref">Equation&nbsp;<span>12.1</span></a> needs to be evaluated several hundred times during the numerical optimization algorithm. The computational issues were handled by:</p>
<ol type="1">
<li><p>Developing a fast implementation of <a href="#eq-map-decoder-simple" class="quarto-xref">Equation&nbsp;<span>12.1</span></a> that leverages sorting logic. The implementation is in the code section as <code>map.decoder.success.prob()</code> below.</p></li>
<li><p>Selecting only 10 percent of all outputs as a sample instead of the entire population. The probability of the <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th output being selected is proportional to the probability mass <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_S(i)</annotation></semantics></math>. About 96 percent of the total probability mass is included because high-probability outputs are more likely to be selected.</p></li>
</ol>
</section>
<section id="excess-tail-penalty" class="level3" data-number="12.3.2">
<h3 data-number="12.3.2" class="anchored" data-anchor-id="excess-tail-penalty"><span class="header-section-number">12.3.2</span> Excess tail penalty</h3>
<p>During fitting, the probability mass that is older than the oldest output is added back to the rest of the probability distribution. This procedure reflects the fact that a wallet would re-draw a random output that is older than the oldest RingCT output. During fitting, I sometimes observed excessive “flattening” of the probability distribution where the portion of the distribution that extended past the oldest output exceeded 70 percent. There was a need to discourage the optimizer from flattening the distribution.</p>
<p>I added an excess tail penalty. When 10 percent or more of the distribution’s mass extends past the oldest output, a proportional penalty is added to the optimizer’s objective function.</p>
</section>
<section id="parameter-initial-values" class="level3" data-number="12.3.3">
<h3 data-number="12.3.3" class="anchored" data-anchor-id="parameter-initial-values"><span class="header-section-number">12.3.3</span> Parameter initial values</h3>
<p>I use the <a href="https://en.wikipedia.org/wiki/Nelder%E2%80%93Mead_method">Nelder-Mead algorithm</a> to minimize the objective functions. Nelder-Mead, like most optimization algorithms, needs initial parameter values to start the optimization procedure. The starting values are obtained by drawing 10,000 observations from the real spend distribution and estimating the appropriate maximum likelihood model parameter estimates. Of course, the maximum likelihood methods need starting values. See the documentation of the maximum likelihood R functions in the code below for details. There was no automatic method to select starting values for the noncentral F distribution. In that case, I manually specified reasonable starting values.</p>
</section>
</section>
<section id="sec-parametric-fit-code" class="level2 page-columns page-full" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="sec-parametric-fit-code"><span class="header-section-number">12.4</span> Code</h2>
<p>This code can be run in a new R session. It may take a day or two to run on a powerful machine.</p>
<div class="cell column-page">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>results.dir <span class="ot">&lt;-</span> <span class="st">"results"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>excl.weeks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2023-13.qs"</span>, <span class="st">"2023-14.qs"</span>, <span class="st">"2023-51.qs"</span>, <span class="st">"2023-52.qs"</span>, <span class="st">"2024-01.qs"</span>, <span class="st">"2024-02.qs"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2024-06.qs"</span>, <span class="st">"2024-09.qs"</span>, <span class="st">"2024-10.qs"</span>, <span class="st">"2024-11.qs"</span>, <span class="st">"2024-12.qs"</span>, <span class="st">"2024-13.qs"</span>, <span class="st">"2024-14.qs"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2024-15.qs"</span>, <span class="st">"2024-16.qs"</span>, <span class="st">"2024-17.qs"</span>, <span class="st">"2024-19.qs"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>lambda.params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>results.dir.run <span class="ot">&lt;-</span> <span class="fu">paste0</span>(results.dir, <span class="st">"/results-01/"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>nonparametric.real.spend <span class="ot">&lt;-</span> qs<span class="sc">::</span><span class="fu">qread</span>(<span class="at">file =</span> <span class="fu">paste0</span>(results.dir.run, <span class="st">"nonparametric-real-spend.qs"</span>))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>nonparametric.real.spend <span class="ot">&lt;-</span> nonparametric.real.spend<span class="sc">$</span>rucknium</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>weekly.real.spend.cdfs <span class="ot">&lt;-</span> nonparametric.real.spend<span class="sc">$</span>weekly.real.spend.cdfs</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>all.weeks.weighted.v.mean <span class="ot">&lt;-</span> nonparametric.real.spend<span class="sc">$</span>all.weeks.weighted.v.mean</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>weighted.v.mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(all.weeks.weighted.v.mean)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>support.max <span class="ot">&lt;-</span> nonparametric.real.spend<span class="sc">$</span>support.max</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>all.weeks.weighted.v.mean <span class="ot">&lt;-</span> all.weeks.weighted.v.mean[<span class="sc">!</span> <span class="fu">names</span>(all.weeks.weighted.v.mean) <span class="sc">%in%</span> excl.weeks]</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>aggregate.real.spend.pmf <span class="ot">&lt;-</span> <span class="fu">diff</span>(weekly.real.spend.cdfs[[<span class="dv">1</span>]](<span class="fu">as.numeric</span>(<span class="dv">0</span><span class="sc">:</span>(support.max <span class="sc">+</span> <span class="dv">1</span>))))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (week <span class="cf">in</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(weekly.real.spend.cdfs)[<span class="sc">-</span><span class="dv">1</span>], excl.weeks)) {</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(week, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  aggregate.real.spend.pmf <span class="ot">&lt;-</span> aggregate.real.spend.pmf <span class="sc">+</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diff</span>(weekly.real.spend.cdfs[[week]](<span class="fu">as.numeric</span>(<span class="dv">0</span><span class="sc">:</span>(support.max <span class="sc">+</span> <span class="dv">1</span>))))</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>aggregate.real.spend.pmf <span class="ot">&lt;-</span> aggregate.real.spend.pmf<span class="sc">/</span><span class="fu">sum</span>(aggregate.real.spend.pmf)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all.equal</span>(<span class="dv">1</span>, <span class="fu">sum</span>(aggregate.real.spend.pmf)))</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>get.decoy.pmf <span class="ot">&lt;-</span> <span class="cf">function</span>(cdf, v, z, sub.supp, <span class="at">log.trans =</span> <span class="cn">FALSE</span>, ...) {</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  G <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cdf</span>(x, ...)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (log.trans) {</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    G_star <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">G</span>(<span class="fu">log1p</span>(x<span class="sc">*</span>v))<span class="sc">/</span><span class="fu">G</span>(<span class="fu">log1p</span>(z<span class="sc">*</span>v))</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    G_star <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">G</span>(x<span class="sc">*</span>v)<span class="sc">/</span><span class="fu">G</span>(z<span class="sc">*</span>v)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">G_star</span>(sub.supp) <span class="sc">-</span> <span class="fu">G_star</span>(sub.supp <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>param.trans <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>f_D.lgamma <span class="ot">&lt;-</span> <span class="cf">function</span>(param, v, z, sub.supp, get.decoy.pmf) {</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">decoy.pmf =</span>  <span class="fu">get.decoy.pmf</span>(actuar<span class="sc">::</span>plgamma, v, z, <span class="at">sub.supp =</span> sub.supp, <span class="at">shapelog =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">ratelog =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>])),</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">tail.beyond.support =</span> <span class="dv">1</span> <span class="sc">-</span> actuar<span class="sc">::</span><span class="fu">plgamma</span>(z<span class="sc">*</span>v, <span class="at">shapelog =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">ratelog =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>])))</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>param.trans<span class="sc">$</span>lgamma <span class="ot">&lt;-</span> <span class="fu">c</span>(exp, exp)</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>f_D.gamma <span class="ot">&lt;-</span> <span class="cf">function</span>(param, v, z, sub.supp, get.decoy.pmf, log.trans) {</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">decoy.pmf =</span>  <span class="fu">get.decoy.pmf</span>(stats<span class="sc">::</span>pgamma, v, z, <span class="at">sub.supp =</span> sub.supp, <span class="at">log.trans =</span> log.trans, <span class="at">shape =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">rate =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>])),</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">tail.beyond.support =</span> <span class="dv">1</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pgamma</span>(<span class="fu">ifelse</span>(log.trans, <span class="fu">log1p</span>(z<span class="sc">*</span>v), z<span class="sc">*</span>v), <span class="at">shape =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">rate =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>])))</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>param.trans<span class="sc">$</span>gamma <span class="ot">&lt;-</span> <span class="fu">c</span>(exp, exp)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>f_D.f <span class="ot">&lt;-</span> <span class="cf">function</span>(param, v, z, sub.supp, get.decoy.pmf, log.trans) {</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">decoy.pmf =</span>  <span class="fu">get.decoy.pmf</span>(<span class="at">cdf =</span> stats<span class="sc">::</span>pf, v, z, sub.supp, <span class="at">log.trans =</span> log.trans, <span class="at">df1 =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">df2 =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>]), <span class="at">ncp =</span> <span class="fu">exp</span>(param[<span class="dv">3</span>])),</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">tail.beyond.support =</span> <span class="dv">1</span> <span class="sc">-</span> stats<span class="sc">::</span><span class="fu">pf</span>(<span class="fu">ifelse</span>(log.trans, <span class="fu">log1p</span>(z<span class="sc">*</span>v), z<span class="sc">*</span>v),  <span class="at">df1 =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">df2 =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>]), <span class="at">ncp =</span> <span class="fu">exp</span>(param[<span class="dv">3</span>])))</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>param.trans<span class="sc">$</span>f <span class="ot">&lt;-</span> <span class="fu">c</span>(exp, exp, exp)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>f_D.rpln <span class="ot">&lt;-</span> <span class="cf">function</span>(param, v, z, sub.supp, get.decoy.pmf, log.trans, <span class="at">return.log =</span> <span class="cn">FALSE</span>, ...) {</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">decoy.pmf =</span>  <span class="fu">get.decoy.pmf</span>(distributionsrd<span class="sc">::</span>prightparetolognormal, v, z, sub.supp, <span class="at">log.trans =</span> log.trans, <span class="at">shape2 =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]),</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanlog =</span> param[<span class="dv">2</span>], <span class="at">sdlog =</span> <span class="fu">exp</span>(param[<span class="dv">3</span>]), <span class="at">lower.tail =</span> <span class="cn">TRUE</span>, <span class="at">log.p =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">tail.beyond.support =</span> <span class="dv">1</span> <span class="sc">-</span> distributionsrd<span class="sc">::</span><span class="fu">prightparetolognormal</span>(<span class="fu">ifelse</span>(log.trans, <span class="fu">log1p</span>(z<span class="sc">*</span>v), z<span class="sc">*</span>v), <span class="at">shape2 =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">meanlog =</span> param[<span class="dv">2</span>], <span class="at">sdlog =</span> <span class="fu">exp</span>(param[<span class="dv">3</span>]), <span class="at">lower.tail =</span> <span class="cn">TRUE</span>, <span class="at">log.p =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>param.trans<span class="sc">$</span>rpln <span class="ot">&lt;-</span> <span class="fu">c</span>(exp, I, exp)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>f_D.gev <span class="ot">&lt;-</span> <span class="cf">function</span>(param, v, z, sub.supp, get.decoy.pmf, log.trans) {</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">decoy.pmf =</span>  <span class="fu">get.decoy.pmf</span>(VGAM<span class="sc">::</span>pgev, v, z, <span class="at">sub.supp =</span> sub.supp, <span class="at">log.trans =</span> log.trans, <span class="at">location =</span> param[<span class="dv">1</span>], <span class="at">scale =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>]), <span class="at">shape =</span> param[<span class="dv">3</span>]),</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">tail.beyond.support =</span> <span class="dv">1</span> <span class="sc">-</span> VGAM<span class="sc">::</span><span class="fu">pgev</span>(<span class="fu">ifelse</span>(log.trans, <span class="fu">log1p</span>(z<span class="sc">*</span>v), z<span class="sc">*</span>v), <span class="at">location =</span> param[<span class="dv">1</span>], <span class="at">scale =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>]), <span class="at">shape =</span> param[<span class="dv">3</span>]))</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>param.trans<span class="sc">$</span>gev <span class="ot">&lt;-</span> <span class="fu">c</span>(I, exp, I)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>f_D.bs <span class="ot">&lt;-</span> <span class="cf">function</span>(param, v, z, sub.supp, get.decoy.pmf, log.trans) {</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">decoy.pmf =</span>  <span class="fu">get.decoy.pmf</span>(<span class="at">cdf =</span> bsgof<span class="sc">::</span>pbs, v, z, sub.supp, <span class="at">log.trans =</span> log.trans, <span class="at">alpha =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">beta =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>])),</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">tail.beyond.support =</span> <span class="dv">1</span> <span class="sc">-</span> bsgof<span class="sc">::</span><span class="fu">pbs</span>(<span class="fu">ifelse</span>(log.trans, <span class="fu">log1p</span>(z<span class="sc">*</span>v), z<span class="sc">*</span>v), <span class="at">alpha =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">beta =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>])))</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>param.trans<span class="sc">$</span>bs <span class="ot">&lt;-</span> <span class="fu">c</span>(exp, exp)</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>f_D.gb2 <span class="ot">&lt;-</span> <span class="cf">function</span>(param, v, z, sub.supp, get.decoy.pmf, log.trans) {</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">decoy.pmf =</span>  <span class="fu">get.decoy.pmf</span>(<span class="at">cdf =</span> GB2<span class="sc">::</span>pgb2, v, z, sub.supp, <span class="at">log.trans =</span> log.trans, <span class="at">shape1 =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">scale =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>]), <span class="at">shape2 =</span> <span class="fu">exp</span>(param[<span class="dv">3</span>]), <span class="at">shape3 =</span> <span class="fu">exp</span>(param[<span class="dv">4</span>])),</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">tail.beyond.support =</span> <span class="dv">1</span> <span class="sc">-</span> GB2<span class="sc">::</span><span class="fu">pgb2</span>(<span class="fu">ifelse</span>(log.trans, <span class="fu">log1p</span>(z<span class="sc">*</span>v), z<span class="sc">*</span>v), <span class="at">shape1 =</span> <span class="fu">exp</span>(param[<span class="dv">1</span>]), <span class="at">scale =</span> <span class="fu">exp</span>(param[<span class="dv">2</span>]), <span class="at">shape2 =</span> <span class="fu">exp</span>(param[<span class="dv">3</span>]), <span class="at">shape3 =</span> <span class="fu">exp</span>(param[<span class="dv">4</span>])))</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>param.trans<span class="sc">$</span>gb2 <span class="ot">&lt;-</span> <span class="fu">c</span>(exp, exp, exp, exp)</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>map.decoder.success.prob <span class="ot">&lt;-</span> <span class="cf">function</span>(f_S, f_D) {</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This implementation assumes that every output selected in a ring</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># is unique (i.e. does not handle multi-output aggregates like </span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pseudo-blocks). The inequality comparison is strict.</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>  cut.vector <span class="ot">&lt;-</span> f_S<span class="sc">/</span>f_D</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(f_S)</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(cut.vector) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cut.vector))</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">f_D =</span> f_D, <span class="at">cut.vector.var =</span> cut.vector)</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setorder</span>(y, cut.vector.var)</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>  cut.vector <span class="ot">&lt;-</span> <span class="fu">sort</span>(cut.vector)</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>  cut.vector.unique <span class="ot">&lt;-</span> cut.vector[<span class="sc">!</span><span class="fu">duplicated</span>(cut.vector)]</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Using duplicated() keeps names. unique() does not keep names.</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>  cut.vector.name.unique <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">names</span>(cut.vector.unique))</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>  y[, cut.vector.cut <span class="sc">:</span><span class="er">=</span> cut.vector.name.unique[ <span class="fu">.bincode</span>(cut.vector.var, <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, cut.vector.unique), <span class="at">right =</span> <span class="cn">FALSE</span>)] ]</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setorder</span>(y, cut.vector.var)</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>  y[, cut.vector.var <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>  y[, f_D <span class="sc">:</span><span class="er">=</span> <span class="fu">cumsum</span>(f_D)]</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(f_D)</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[, .(<span class="at">success.prob =</span> f_D[.N]), by <span class="ot">=</span> cut.vector.cut]</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">merge</span>(y, <span class="fu">data.table</span>(<span class="at">cut.vector.cut =</span> cut.vector.name.unique, <span class="at">cut.vector =</span> cut.vector.unique))</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(cut.vector.name.unique)</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>  y[, cut.vector.cut <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">merge</span>(y, <span class="fu">data.table</span>(<span class="at">cut.vector.cut.names =</span> <span class="fu">as.integer</span>(<span class="fu">names</span>(cut.vector)), <span class="at">cut.vector =</span> <span class="fu">unname</span>(cut.vector)),</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">all =</span> <span class="cn">TRUE</span>, <span class="at">by =</span> <span class="st">"cut.vector"</span>)</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>  y[, cut.vector <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setorder</span>(y, cut.vector.cut.names)</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>  y[, cut.vector.cut.names <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setDF</span>(y)</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>  y<span class="sc">$</span>success.prob[<span class="fu">is.na</span>(y<span class="sc">$</span>success.prob)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>  <span class="co"># At the point(s) where f_S/f_D is at a minimum, the attack would always</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># choose another block height, so the attack success probability is zero</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y<span class="sc">$</span>success.prob</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># gc()</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>  y</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>L_Attack <span class="ot">&lt;-</span> <span class="cf">function</span>(param, f_D, v, z, sub.supp, theta_i, get.decoy.pmf, map.decoder.success.prob, <span class="at">lambda =</span> <span class="dv">1</span>, log.trans) {</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>  f_D.return <span class="ot">&lt;-</span> <span class="fu">f_D</span>(param, v, z, sub.supp, get.decoy.pmf, log.trans)</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>  a_i <span class="ot">&lt;-</span> f_D.return<span class="sc">$</span>decoy.pmf</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>  tail.penalty <span class="ot">&lt;-</span> f_D.return<span class="sc">$</span>tail.beyond.support</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(f_D.return)</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span> <span class="fu">is.finite</span>(a_i))) { <span class="fu">return</span>(<span class="dv">1</span>) }</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>  a_i[a_i <span class="sc">&lt;=</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> .Machine<span class="sc">$</span>double.eps</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>  values.map.decoder.success.prob <span class="ot">&lt;-</span> <span class="fu">map.decoder.success.prob</span>(<span class="at">f_S =</span> theta_i<span class="sc">/</span><span class="fu">sum</span>(theta_i), <span class="at">f_D =</span> a_i<span class="sc">/</span><span class="fu">sum</span>(a_i))</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>  n.decoys <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">round</span>(tail.penalty, <span class="dv">5</span>), <span class="st">"&lt;&gt;"</span>)</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>  tail.penalty <span class="ot">&lt;-</span> tail.penalty <span class="sc">-</span> <span class="fl">0.10</span> <span class="co"># 0.05</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (tail.penalty <span class="sc">&lt;=</span> <span class="dv">0</span>) {tail.penalty <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(values.map.decoder.success.prob) <span class="sc">==</span> <span class="fu">length</span>(theta_i))</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> lambda <span class="sc">*</span> (theta_i<span class="sc">/</span><span class="fu">sum</span>(theta_i)) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> lambda) <span class="sc">*</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">length</span>(theta_i)</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(weight <span class="sc">*</span> (values.map.decoder.success.prob)<span class="sc">^</span>n.decoys) <span class="sc">+</span> tail.penalty</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>theta_i <span class="ot">&lt;-</span> aggregate.real.spend.pmf</span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>theta_i[theta_i <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> .Machine<span class="sc">$</span>double.eps</span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">length</span>(theta_i)</span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">mean</span>(all.weeks.weighted.v.mean)</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">314</span>)</span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>sub.supp <span class="ot">&lt;-</span> wrswoR<span class="sc">::</span><span class="fu">sample_int_expj</span>(<span class="fu">length</span>(theta_i), <span class="fu">ceiling</span>(<span class="fu">length</span>(theta_i)<span class="sc">/</span><span class="dv">10</span>), <span class="at">prob =</span> theta_i)</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a><span class="co"># wrswoR::sample_int_expj is much faster than sample() when the prob vector is long</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a><span class="co"># start at 2 so G(x - 1) is not 0</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>sub.supp <span class="ot">&lt;-</span> <span class="fu">sort</span>(sub.supp)</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>theta_i <span class="ot">&lt;-</span> theta_i[sub.supp]</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>gen.data <span class="ot">&lt;-</span> <span class="fu">stepfun</span>( <span class="fu">cumsum</span>(theta_i<span class="sc">/</span><span class="fu">sum</span>(theta_i)), <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">as.numeric</span>(sub.supp)) )</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>mle.generated.data <span class="ot">&lt;-</span> <span class="fu">gen.data</span>(<span class="fu">runif</span>(<span class="dv">10000</span>))</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>mle.generated.data <span class="ot">&lt;-</span> mle.generated.data[mle.generated.data <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>gamma.fit <span class="ot">&lt;-</span> Rfast<span class="sc">::</span><span class="fu">gammamle</span>(mle.generated.data)</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>gamma.fit.coef <span class="ot">&lt;-</span> <span class="fu">log</span>(gamma.fit<span class="sc">$</span>param)</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>gamma.fit <span class="ot">&lt;-</span> Rfast<span class="sc">::</span><span class="fu">gammamle</span>(<span class="fu">log1p</span>(mle.generated.data))</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>gamma.fit.coef.log <span class="ot">&lt;-</span> <span class="fu">log</span>(gamma.fit<span class="sc">$</span>param)</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>f.fit <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdist</span>(mle.generated.data, <span class="st">"f"</span>, <span class="at">method =</span> <span class="st">"mle"</span>, <span class="at">start =</span> <span class="fu">list</span>(<span class="at">df1 =</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span>), <span class="at">df2 =</span> <span class="fu">exp</span>(<span class="dv">0</span>), <span class="at">ncp =</span> <span class="fu">exp</span>(<span class="dv">2</span>)))</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>f.fit.coef <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">coef</span>(f.fit))</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>f.fit <span class="ot">&lt;-</span> fitdistrplus<span class="sc">::</span><span class="fu">fitdist</span>(<span class="fu">log1p</span>(mle.generated.data), <span class="st">"f"</span>, <span class="at">method =</span> <span class="st">"mle"</span>, <span class="at">start =</span> <span class="fu">list</span>(<span class="at">df1 =</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span>), <span class="at">df2 =</span> <span class="fu">exp</span>(<span class="dv">0</span>), <span class="at">ncp =</span> <span class="fu">exp</span>(<span class="dv">2</span>)))</span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>f.fit.coef.log <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">coef</span>(f.fit))</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>rpln.fit <span class="ot">&lt;-</span> distributionsrd<span class="sc">::</span><span class="fu">rightparetolognormal.mle</span>(mle.generated.data)</span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>rpln.fit.coef <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">log</span>(rpln.fit<span class="sc">$</span>coefficients[[<span class="st">"shape2"</span>]]), rpln.fit<span class="sc">$</span>coefficients[[<span class="st">"meanlog"</span>]],</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(rpln.fit<span class="sc">$</span>coefficients[[<span class="st">"sdlog"</span>]]) )</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>rpln.fit <span class="ot">&lt;-</span> distributionsrd<span class="sc">::</span><span class="fu">rightparetolognormal.mle</span>(<span class="fu">log1p</span>(mle.generated.data))</span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>rpln.fit.coef.log <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">log</span>(rpln.fit<span class="sc">$</span>coefficients[[<span class="st">"shape2"</span>]]), rpln.fit<span class="sc">$</span>coefficients[[<span class="st">"meanlog"</span>]],</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(rpln.fit<span class="sc">$</span>coefficients[[<span class="st">"sdlog"</span>]]) )</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>gev.fit <span class="ot">&lt;-</span> VGAM<span class="sc">::</span><span class="fu">vglm</span>(mle.generated.data <span class="sc">~</span> <span class="dv">1</span>, VGAM<span class="sc">::</span>gevff, <span class="at">control =</span> VGAM<span class="sc">::</span><span class="fu">vglm.control</span>(<span class="at">maxit =</span> <span class="dv">1000</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>gev.fit.coef <span class="ot">&lt;-</span> VGAM<span class="sc">::</span><span class="fu">Coef</span>(gev.fit)</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>gev.fit.coef[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">log</span>(gev.fit.coef[<span class="dv">2</span>])</span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>gev.fit <span class="ot">&lt;-</span> VGAM<span class="sc">::</span><span class="fu">vglm</span>(<span class="fu">log1p</span>(mle.generated.data) <span class="sc">~</span> <span class="dv">1</span>, VGAM<span class="sc">::</span>gevff, <span class="at">control =</span> VGAM<span class="sc">::</span><span class="fu">vglm.control</span>(<span class="at">maxit =</span> <span class="dv">1000</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>gev.fit.coef.log <span class="ot">&lt;-</span> VGAM<span class="sc">::</span><span class="fu">Coef</span>(gev.fit)</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>gev.fit.coef.log[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">log</span>(gev.fit.coef.log[<span class="dv">2</span>])</span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>bs.fit <span class="ot">&lt;-</span> bsgof<span class="sc">::</span><span class="fu">bs.mle</span>(mle.generated.data)</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>bs.fit.coef <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">c</span>(bs.fit<span class="sc">$</span>alpha, bs.fit<span class="sc">$</span>beta))</span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>bs.fit <span class="ot">&lt;-</span> bsgof<span class="sc">::</span><span class="fu">bs.mle</span>(<span class="fu">log1p</span>(mle.generated.data))</span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>bs.fit.coef.log <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">c</span>(bs.fit<span class="sc">$</span>alpha, bs.fit<span class="sc">$</span>beta))</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>gb2.fit <span class="ot">&lt;-</span> GB2<span class="sc">::</span><span class="fu">mlfit.gb2</span>(mle.generated.data)</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>gb2.fit.coef <span class="ot">&lt;-</span> <span class="fu">log</span>(gb2.fit[[<span class="dv">2</span>]]<span class="sc">$</span>par)</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>gb2.fit <span class="ot">&lt;-</span> GB2<span class="sc">::</span><span class="fu">mlfit.gb2</span>(<span class="fu">log1p</span>(mle.generated.data <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>gb2.fit.coef.log <span class="ot">&lt;-</span> <span class="fu">log</span>(gb2.fit[[<span class="dv">2</span>]]<span class="sc">$</span>par)</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>run.iters.simple <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_D =</span> <span class="fu">c</span>(</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_D.gamma =</span> f_D.gamma,</span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_D.f =</span> f_D.f,</span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_D.rpln =</span> f_D.rpln,</span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_D.gev =</span> f_D.gev,</span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_D.bs =</span> f_D.bs,</span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_D.gb2 =</span> f_D.gb2</span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>  <span class="at">flavor =</span> <span class="dv">1</span>,</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>  <span class="at">week =</span> <span class="dv">0</span>,</span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>  <span class="at">est.method =</span> <span class="dv">0</span>,</span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>  <span class="at">L =</span> <span class="fu">c</span>(<span class="at">L_Attack =</span> L_Attack),</span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> lambda.params,</span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>  <span class="at">log.trans =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>)</span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>start.params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_D.gamma =</span> <span class="fu">list</span>(<span class="at">no.log =</span> gamma.fit.coef, <span class="at">log =</span> gamma.fit.coef.log),</span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_D.f =</span> <span class="fu">list</span>(<span class="at">no.log =</span> f.fit.coef, <span class="at">log =</span> f.fit.coef.log),</span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_D.rpln =</span> <span class="fu">list</span>(<span class="at">no.log =</span> rpln.fit.coef, <span class="at">log =</span> rpln.fit.coef.log),</span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_D.gev =</span> <span class="fu">list</span>(<span class="at">no.log =</span> gev.fit.coef, <span class="at">log =</span> gev.fit.coef.log),</span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_D.bs =</span> <span class="fu">list</span>(<span class="at">no.log =</span> bs.fit.coef, <span class="at">log =</span> bs.fit.coef.log),</span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_D.gb2 =</span> <span class="fu">list</span>(<span class="at">no.log =</span> gb2.fit.coef, <span class="at">log =</span> gb2.fit.coef.log))</span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>threads <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(run.iters.simple)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(future<span class="sc">::</span><span class="fu">multisession</span>(<span class="at">workers =</span> threads))</span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>keep.time <span class="ot">&lt;-</span> base<span class="sc">::</span><span class="fu">date</span>()</span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>fit.results <span class="ot">&lt;-</span> future.apply<span class="sc">::</span><span class="fu">future_lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(run.iters.simple), <span class="cf">function</span>(iter) {</span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a>  f_D.fun <span class="ot">&lt;-</span> run.iters.simple<span class="sc">$</span>f_D[[iter]]</span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a>  L.fun <span class="ot">&lt;-</span> run.iters.simple<span class="sc">$</span>L[[iter]]</span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a>  flavor <span class="ot">&lt;-</span> run.iters.simple<span class="sc">$</span>flavor[[iter]]</span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> run.iters.simple<span class="sc">$</span>lambda[[iter]]</span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>  log.trans <span class="ot">&lt;-</span> run.iters.simple<span class="sc">$</span>log.trans[[iter]]</span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (log.trans) {</span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>    start.params.optim <span class="ot">&lt;-</span> start.params[[<span class="fu">names</span>(run.iters.simple<span class="sc">$</span>f_D[iter])]]<span class="sc">$</span>log</span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>    start.params.optim <span class="ot">&lt;-</span> start.params[[<span class="fu">names</span>(run.iters.simple<span class="sc">$</span>f_D[iter])]]<span class="sc">$</span>no.log</span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>  optim.results <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a>    start.params.optim,</span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>    L.fun,</span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_D =</span> f_D.fun,</span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">v =</span> v,</span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> z,</span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>    <span class="at">sub.supp =</span> sub.supp,</span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">get.decoy.pmf =</span> get.decoy.pmf,</span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a>    <span class="at">map.decoder.success.prob =</span> map.decoder.success.prob,</span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>    <span class="at">log.trans =</span> log.trans,</span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> lambda, </span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"Nelder-Mead"</span>, </span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="dv">6</span>, <span class="at">maxit =</span> <span class="dv">10000</span>),</span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_i =</span> theta_i)</span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>  optim.results</span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>}, <span class="at">future.globals =</span> <span class="fu">c</span>(<span class="st">"run.iters.simple"</span>, <span class="st">"start.params"</span>, <span class="st">"v"</span>, <span class="st">"z"</span>, <span class="st">"sub.supp"</span>, <span class="st">"get.decoy.pmf"</span>,</span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a>  <span class="st">"map.decoder.success.prob"</span>, <span class="st">"theta_i"</span>, <span class="st">"lamba.iter"</span>),</span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>  <span class="at">future.packages =</span> <span class="st">"data.table"</span>, <span class="at">future.seed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(keep.time)</span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="fu">date</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Aeeneh2021" class="csl-entry" role="listitem">
Aeeneh, Sina, João Otávio Chervinski, Jiangshan Yu, and Nikola Zlatanov. 2021. <span>“New Attacks on the Untraceability of Transactions in CryptoNote-Style Blockchains.”</span> In <em>2021 IEEE International Conference on Blockchain and Cryptocurrency (ICBC)</em>, 1–5. <a href="https://doi.org/10.1109/ICBC51069.2021.9461130">https://doi.org/10.1109/ICBC51069.2021.9461130</a>.
</div>
<div id="ref-ReedJorgensen2004" class="csl-entry" role="listitem">
Reed, William J., and Murray Jorgensen. 2004. <span>“The Double Pareto-Lognormal Distribution—a New Parametric Model for Size Distributions.”</span> <em>Communications in Statistics - Theory and Methods</em> 33 (8): 1733–53. <a href="https://doi.org/10.1081/STA-120037438">https://doi.org/10.1081/STA-120037438</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./real-spend-visualization.html" class="pagination-link" aria-label="Real Spend Visualization">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Real Spend Visualization</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./performance-evaluation.html" class="pagination-link" aria-label="Performance Evaluation">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Performance Evaluation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>