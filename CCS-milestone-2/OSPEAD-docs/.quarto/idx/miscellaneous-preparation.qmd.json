{"title":"Miscellaneous Preparation","markdown":{"headingText":"Miscellaneous Preparation","containsRefs":false,"markdown":"\nThis script does three things:\n\n1) Assigns each ring a boolean TRUE/FALSE value for `is.nonstandard.rucknium` and `is.nonstandard.isthmus` based on whether its transaction hash was identified as a nonstandard transaction in @sec-nonstandard-transactions .\n\n2) Rarely, ring members can have an age that is younger than the block the transaction was confirmed in. The time recorded by the txpool archive database and the blockchain may disagree because of loose block timestamp rules. In this case, the age of every ring member is shifted so that all ring members have a valid non-negative age.\n\n3) An `output.index.only.locked` object is created. This is a record of the unlock time of outputs with nonzero unlock time, including coinbase outputs. This is a necessary piece of data to compute the decoy selection probability distribution at every block height, whose support only includes outputs that have a nonzero probability of being selected as decoys, i.e. outputs that are actually spendable at the time of transaction construction.\n\nAgain, input this code in the same R session as used in previous chapters.\n\n## Code\n\n```{r}\n#| column: page\n\nxmr.rings[, is.nonstandard.rucknium :=\n  (tx_hash %chin% tx.hash.nonstandard.fees) |\n  (tx_hash %chin% tx.hash.nonstandard.unlock.time) |\n  is_mordinal_ring | is_mordinal_transfer_ring]\n\nxmr.rings[, is.nonstandard.isthmus := tx_hash %chin% isthmus.anomalous.hashes]\n\nrm(tx.hash.nonstandard.fees, tx.hash.nonstandard.unlock.time, isthmus.anomalous.hashes)\n\n\nyoungest.RingCT <- output.index[ output_amount == 0 | tx_num == 1,\n  .(youngest.output.index = max(output_index)), by = \"block_height\"]\n\n# rm(output.index)\n# TODO: uncomment this\n\nyoungest.RingCT <- merge(youngest.RingCT,\n  data.table(block_height = min(youngest.RingCT$block_height):max(youngest.RingCT$block_height)),\n  all = TRUE)\n\nyoungest.RingCT[, youngest.output.index :=\n  zoo::na.locf(youngest.output.index, na.rm = FALSE)]\n# Before RingCT outputs were mandatory, some blocks had zero RingCT-eligible outputs.\n# These lines make sure that these blocks are included in the dataset\n\nyoungest.RingCT[, block_height := block_height + 9L]\n# Used to be 10L before block_height_ring changed to block_height_ring.at.construction below\n\nxmr.rings <- merge(xmr.rings, youngest.RingCT, all.x = TRUE, by.x = \"block_height_ring.at.construction\", by.y = \"block_height\")\n# Need all.x = TRUE because will have NAs for the first 10 blocks of youngest.output.index\n\n\n\nxmr.rings[, ring_member_age := youngest.output.index - output_index]\n# xmr.rings[, table(ring_member_age < 0) ]\n# > 1798220 /357314244\n# [1] 0.005032601\n\nxmr.rings[, ring_member_age := ring_member_age + 1]\n# Add 1 so youngest ring member is 1, not zero\n\n\nfetus.rings <- xmr.rings[ring_member_age <= 0, ]\n\nfetus.rings <- merge(unique(fetus.rings[, .(tx_hash, input_num)]), xmr.rings, by = c(\"tx_hash\", \"input_num\"))\nsetcolorder(fetus.rings, colnames(xmr.rings))\nnrow(xmr.rings)\nxmr.rings <- fsetdiff(xmr.rings, fetus.rings)\nnrow(xmr.rings)\n# This is anti-join\n\nn.fetus.rings <- n.fetus.rings.initial <- nrow(fetus.rings)\n\nborn.rings <- fetus.rings[FALSE, ]\n\nyoungest.RingCT.rolling <- copy(youngest.RingCT)\n\nfetus.rings[, ring_member_age := NULL]\nfetus.rings[, youngest.output.index := NULL]\n\ni <- 0\nwhile (n.fetus.rings > 0) {\n  i <- i + 1\n  youngest.RingCT.rolling[, block_height := block_height - 1L]\n  birthing.rings <- merge(fetus.rings, youngest.RingCT.rolling, all.x = TRUE, by.x = \"block_height_ring.at.construction\", by.y = \"block_height\")\n  birthing.rings[, ring_member_age := youngest.output.index - output_index]\n  birthing.rings[, any.fetus := any(ring_member_age <= 0), by = c(\"tx_hash\", \"input_num\")]\n\n  if (all(birthing.rings$any.fetus)) { next }\n\n  fetus.rings <- birthing.rings[(any.fetus), ]\n  fetus.rings[, ring_member_age := NULL]\n  fetus.rings[, youngest.output.index := NULL]\n  any.fetus.external <- birthing.rings[, any.fetus]\n  birthing.rings[, any.fetus := NULL]\n\n  born.rings <- rbind(born.rings, birthing.rings[(! any.fetus.external), ])\n\n  n.fetus.rings <- nrow(fetus.rings)\n\n  if (i >= 1000) { break }\n  # Don't go further than 1000 blocks. The few rings\n  # that cannot be repaired after 1000 blocks will be excluded from the analysis\n\n}\n# The vast majority are off-by-one-block\n\nstopifnot(nrow(born.rings) + n.fetus.rings == n.fetus.rings.initial)\n\nxmr.rings <- rbind(xmr.rings, born.rings)\n\n\n\noutput.index.only.locked <- output.index[\n  output_unlock_time != 0 &\n  (output_amount == 0 | tx_num == 1),\n  .(output_index, output_unlock_time)]\n\n\noutput.index.only.locked.timestamp <- output.index.only.locked[output_unlock_time > 500000000, ]\n# Only about 40 of these have timestamp interpretations instead of block height interpretations\n# https://thecharlatan.ch/Monero-Unlock-Time-Vulns/\n\nblock.timestamps <- unique(output.index[, .(block_height, block_timestamp)])\n\nsetorder(block.timestamps, block_timestamp)\n\noutput.index.only.locked.timestamp[, output_unlock_time := {\n  interval.index <- findInterval(output_unlock_time, block.timestamps$block_timestamp)\n  ifelse(interval.index == 0, 0, 1 + block.timestamps$block_height[interval.index])\n  # If the time is before the earliest block in the dataset, then findInterval() will return a zero index (invalid)\n  # So set it to the genesis block\n  # Technically the genesis block should be unix time zero, but the data gatherer only gets RingCT\n  # txs, which start well after the genesis block.\n  }\n]\n\noutput.index.only.locked.timestamp[output_unlock_time == current.height + 1, output_unlock_time := .Machine$integer.max]\n\noutput.index.only.locked <- rbind(\n  output.index.only.locked[output_unlock_time <= 500000000, ], output.index.only.locked.timestamp)\n\noutput.index.only.locked[, output_unlock_time := as.integer(output_unlock_time)]\noutput.index.only.locked[, output_index := as.integer(output_index)]\n\nsetDF(output.index.only.locked)\n\n# rm(youngest.RingCT)\n\n\n\n\n```\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"gruvbox","html-math-method":"mathml","output-file":"miscellaneous-preparation.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.40","bibliography":["references.bib"],"bibliographystyle":"apa","editor":"visual","theme":"superhero","fig-cap-location":"top"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"miscellaneous-preparation.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"bibliographystyle":"apa","editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}