{"title":"BJR and Patra-Sen","markdown":{"headingText":"BJR and Patra-Sen","headingAttr":{"id":"sec-bjr-and-patra-sen","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\nThis chapter performs the Bonhomme-Jochmans-Robin (BJR) and Patra-Sen estimation. @sec-bjr-explanation and @sec-patra-sen-explanation explain the purpose of the BJR and Patra-Sen estimators, respectively.\n\nThe BJR estimator takes the transformed age data from @sec-transformed-age as input. It outputs four estimated nonparametric cumulative distribution functions (CDFs) of the four components of the mixture distribution and their estimated mixing proportions. It estimates the CDFs at 101 support points: $\\{0.001,0.01,0.02,...,0.98,0.99,0.999\\}$. For a good estimate of the CDFs, I set the support points to have roughly equal probability mass between them. We have transformed the data into a roughly uniform distribution, so the CDF support points are set at a uniform distance from each other, between 0 and 1.\n\nThe estimated component with the highest mixing proportion is selected. This component is used as an input to the Patra-Sen estimator. A Uniform(0,1) distribution is used for the \"decoy\" distribution, $F_{b}(x)$. The output of the Patra-Sen estimation is the estimated real spend distribution.\n\nWe could stop here, but we can do a second-pass estimation for better results. The estimated real spend distribution from the initial Patra-Sen estimation will not have roughly equal probability mass between each CDF support point. We can interpolate the estimated real spend CDF to get new CDF support points that do have roughly equal probability mass between each point. Then the BJR estimation is performed again with the new CDF support points.\n\nThis procedure is followed three times:\n\n1) With all rings\n2) With all rings except for those marked as `is.nonstandard.rucknium`\n3) With all rings except for those marked as `is.nonstandard.rucknium` and/or `is.nonstandard.isthmus`\n\nThe results from these three data subsets can be compared.\n\nThis code will take about two weeks to run on a powerful machine. The code in this chapter can run while the code in @sec-transformed-age is running, but it needs to stay \"behind\" the transformed age data as it is being written to the `cdf.dir` and `ring.member.ages.dir` directories.\n\nThe `threads` variable is the number of CPU threads to use. The `cdf.dir` and `ring.member.ages.dir` variables should be the same as specified in the previous chapter, @sec-transformed-age . `results.dir` is the name of the directory where the BJR estimate will be written to.\n\n## Code\n\n```{r}\n#| column: page\n\nlibrary(decoyanalysis)\nlibrary(future)\nlibrary(data.table)\n\nthreads <- 64 - 17\n\ncdf.dir <- \"weekly-weighted-cdf\"\nring.member.ages.dir <- \"weekly-ring-member-ages\"\nresults.dir <- \"results\"\n\n\n\ndir.create(results.dir)\n\nresults.dir.run <- paste0(results.dir, \"/results-01/\")\n\ndir.create(results.dir.run)\n\nresults.dir.run.bjr <- paste0(results.dir, \"bjr/\")\n\ndir.create(results.dir.run.bjr)\n\n\noptions(future.globals.maxSize = 8000*1024^2)\n\nfuture::plan(future::multicore(workers = threads))\n\ncluster.threads <- NULL\n\nis.raw <- FALSE\n\nif (is.raw) {\n  ring.member.ages.dir <- \"weekly-ring-member-ages-raw\"\n}\n\n\n\n\nfor (i in c(\"all\", \"rucknium\", \"rucknium_isthmus\")) {\n  dir.create(paste0(results.dir.run.bjr, i))\n  dir.create(paste0(results.dir.run.bjr, i, \"/first-pass\"))\n}\n\nxmr.rings.ages.weeks <- list.files(ring.member.ages.dir)\nxmr.rings.ages.weeks <- xmr.rings.ages.weeks[grepl(\".qs\", xmr.rings.ages.weeks)]\nalready.done <- Reduce(intersect, list(list.files(paste0(results.dir.run.bjr, \"all\")),\n  list.files(paste0(results.dir.run.bjr, \"rucknium\")), list.files(paste0(results.dir.run.bjr, \"rucknium_isthmus\"))))\nxmr.rings.ages.weeks <- setdiff(xmr.rings.ages.weeks, already.done)\nxmr.rings.ages.weeks <- rev(sort(xmr.rings.ages.weeks))\n\n\nII <- 10\nK <- 4\n\n# cdf.points <- (0:100)/100\ncdf.points <- c(0.001, (1:99)/100, 0.999)\n#cdf.points <- c(0.0001, (1:99)/100, 0.9999)\n# Distribution should be approximately uniform\n\n\n\nwhile ( length(xmr.rings.ages.weeks) > 0) {\n  week <- xmr.rings.ages.weeks[1]\n\n  y.with.labels <- qs::qread(paste0(ring.member.ages.dir, week))[[1]]\n\n  if (is.raw) {\n    cdf.points <- unname(quantile(c(y), probs = (0:100)/100, na.rm = TRUE))\n  }\n\n  for (label in c(\"all\", \"rucknium\", \"rucknium_isthmus\")) {\n\n\n    if ( ! (label == \"rucknium_isthmus\" &\n        y.with.labels[, sum(is.nonstandard.rucknium) == sum(is.nonstandard.rucknium | is.nonstandard.isthmus)] ) ) {\n      # If is.nonstandard.isthmus does not have additional TRUEs, then just skip and output the Rucknium one\n\n      y <- switch(label,\n        all = y.with.labels[, -(1:2), with = FALSE],\n        rucknium = y.with.labels[! y.with.labels$is.nonstandard.rucknium, -(1:2), with = FALSE],\n        rucknium_isthmus = y.with.labels[! y.with.labels$is.nonstandard.rucknium &\n            ! y.with.labels$is.nonstandard.isthmus, -(1:2), with = FALSE])\n\n      print(system.time(bjr.results <- bjr(y, II = II, K = K, cdf.points = cdf.points,\n        estimate.mean.sd = FALSE, basis = \"Chebychev\", control = list(cluster.threads = cluster.threads ))))\n        \n      qs::qsave(bjr.results, file = paste0(results.dir.run.bjr, label, \"/first-pass/\", week))\n\n      wallet2.dist.index <- which.max(bjr.results$mixing.proportions)\n      Fn.hat.value <- bjr.results$cdf$CDF[, wallet2.dist.index]\n      supp.points <- bjr.results$cdf$cdf.points\n      decoy <- punif\n      Fb <- decoy\n      M = 16\n      alpha <- 1/M\n\n      patra.sen.bjr.results <- patra.sen.bjr(Fn.hat.value, supp.points, Fb, alpha)\n\n      new.cdf.points <-  approx(c(0, patra.sen.bjr.results$Fs.hat, 1), c(0, supp.points, 1), supp.points)$y\n\n      print(system.time(bjr.results.new <- bjr(y, II = II, K = K, cdf.points = new.cdf.points,\n        estimate.mean.sd = FALSE, basis = \"Chebychev\", control = list(cluster.threads = cluster.threads ))))\n\n    }\n\n    qs::qsave(bjr.results.new, file = paste0(results.dir.run.bjr, label, \"/\", week))\n\n  }\n  \n  xmr.rings.ages.weeks <- list.files(ring.member.ages.dir)\n  xmr.rings.ages.weeks <- xmr.rings.ages.weeks[grepl(\".qs\", xmr.rings.ages.weeks)]\n  already.done <- Reduce(intersect, list(list.files(paste0(results.dir.run.bjr, \"all\")),\n    list.files(paste0(results.dir.run.bjr, \"rucknium\")), list.files(paste0(results.dir.run.bjr, \"rucknium_isthmus\"))))\n  xmr.rings.ages.weeks <- setdiff(xmr.rings.ages.weeks, already.done)\n  xmr.rings.ages.weeks <- rev(sort(xmr.rings.ages.weeks))\n\n  cat(week, \"\\n\")\n\n}\n\n\n\n```","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"gruvbox","html-math-method":"mathml","output-file":"bjr-and-patra-sen.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.40","bibliography":["references.bib"],"bibliographystyle":"apa","editor":"visual","theme":"superhero","fig-cap-location":"top"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"bjr-and-patra-sen.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"bibliographystyle":"apa","editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}